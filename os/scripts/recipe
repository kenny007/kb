#!/bin/bash
. "$kb/os/bashset/init.sh"

# exit on any error
# set -e

# check & load params
checkParamsExact $# 2
MODE=$1
APPNAME=$2

# load recipe
load_recipe() {
  # todo make it work for multiple, iterate through params
  # for each with $@

  # todo get rid of other readlink stuff
  #APPFILE="$(dirname "$(readlink -f "$0")")/recipes/$1.sh"
  APPFILE="$kb/os/scripts/recipes/$1.sh"
  if [ -f "$APPFILE" ]; then
    msg_warn "Recipe for $APPNAME not found at $APPFILE"
    source $APPFILE
  else
    echo "aa"
    echo $@
    pkg_delete_array $@
  fi
}
load_recipe $APPNAME

# operate
if [ $MODE == "install" ]; then
  set -e
  pkg_install_array $RECIPE_PKGS
  set +e

  group_add $RECIPE_GROUP
  systemctl_service_enable $RECIPE_SERVICE
  folder_create_array "${RECIPE_FOLDERS_CREATE_HOME[@]}"

  msg_warn "done"
fi

if [ $MODE == "uninstall" ]; then
  if pikaur -Q $RECIPE_PKGS > /dev/null 2>&1; then
    set -e
    pkg_delete_array $RECIPE_PKGS
    set +e
  fi

  group_delete $RECIPE_GROUP
  group_delete_array "${RECIPE_GROUPS_DELETE[@]}"
  users_delete_array "${RECIPE_USERS_DELETE[@]}"
  file_delete_array "${RECIPE_FOLDERS_HOME[@]}"
  file_emptyfolder_array "${RECIPE_FOLDERS_HOME_CLEAN[@]}"
  file_delete_array_with_sudo "${RECIPE_FOLDERS_ROOT[@]}"
  systemctl_service_disable $RECIPE_SERVICE
fi

# TODO implement clean mode ?

msg_ok
